<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Detection Map</title>
<style>
  #map { height: 500px; width: 100%; margin-top: 20px; }
  #video { width: 400px; height: 300px; border: 1px solid black; display: none; }
  #cameraBtn { padding: 10px 20px; font-size: 16px; }
</style>
</head>
<body>

<h2>Live Person Detection Map</h2>
<button id="cameraBtn">Camera On</button>
<video id="video" autoplay muted></video>
<div id="map"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<!-- TensorFlow.js + Coco-SSD -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBPM55I08UVYhUm8XwETLlukc0btlKLE6Q",
    authDomain: "elephant-alert-68626.firebaseapp.com",
    databaseURL: "https://elephant-alert-68626-default-rtdb.firebaseio.com",
    projectId: "elephant-alert-68626",
    storageBucket: "elephant-alert-68626.firebasestorage.app",
    messagingSenderId: "669608211278",
    appId: "1:669608211278:web:11882bbe5bc29910e5641f",
    measurementId: "G-WFZGXHZHHP",
  };

  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // Initialize Map
  let map;
  let marker;
  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      zoom: 10,
      center: { lat: 7.8731, lng: 80.7718 } // Sri Lanka
    });
  }
  initMap();

  // Video & Model
  const video = document.getElementById('video');
  let model;

  document.getElementById('cameraBtn').addEventListener('click', () => {
    // Show video
    video.style.display = 'block';
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => { video.srcObject = stream; })
      .catch(err => console.error("Webcam error:", err));

    // Load model
    cocoSsd.load().then(loadedModel => {
      model = loadedModel;
      detectFrame();
    });
  });

  function detectFrame() {
    model.detect(video).then(predictions => {
      const personDetected = predictions.some(pred => pred.class === 'person' && pred.score > 0.5);
      if(personDetected){
        console.log("Person detected!");
        
        // Example location near map center (replace with real GPS if available)
        const lat = 7.8731 + (Math.random()-0.5)*0.05;
        const lng = 80.7718 + (Math.random()-0.5)*0.05;

        // Update Firebase
        database.ref('liveDetection').set({
          detected: true,
          latitude: lat,
          longitude: lng,
          timestamp: Date.now()
        });

        // Update Map
        const pos = {lat, lng};
        if(!marker){
          marker = new google.maps.Marker({position: pos, map: map});
        } else {
          marker.setPosition(pos);
        }
        map.setCenter(pos);
      }
      requestAnimationFrame(detectFrame);
    });
  }
</script>
</body>
</html>
